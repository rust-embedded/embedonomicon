<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Creating a custom target - The Embedonomicon</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Embedonomicon</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rust-embedded/embedonomicon" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="creating-a-custom-target"><a class="header" href="#creating-a-custom-target">Creating a custom target</a></h1>
<p>If a custom target triple is not available for your platform, you must create a custom target file
that describes your target to <code>rustc</code>.</p>
<p>Keep in mind that it is required to use a nightly compiler to build the core library, which must be
done for a target unknown to <code>rustc</code>.</p>
<h2 id="deciding-on-a-target-triple"><a class="header" href="#deciding-on-a-target-triple">Deciding on a target triple</a></h2>
<p>Many targets already have a known triple used to describe them, typically in the form
ARCH-VENDOR-SYS-ABI. You should aim to use the same triple that <a href="https://clang.llvm.org/docs/CrossCompilation.html#target-triple">LLVM uses</a>;
however, it may differ if you need to specify additional information to Rust that LLVM does not know
about. Although the triple is technically only for human use, it's important for it to be unique and
descriptive especially if the target will be upstreamed in the future.</p>
<p>The ARCH part is typically just the architecture name, except in the case of 32-bit ARM. For
example, you would probably use x86_64 for those processors, but specify the exact ARM architecture
version. Typical values might be <code>armv7</code>, <code>armv5te</code>, or <code>thumbv7neon</code>. Take a look at the names of
the <a href="./compiler-support.html#built-in-target">built-in targets</a> for inspiration.</p>
<p>The VENDOR part is optional and describes the manufacturer. Omitting this field is the same as
using <code>unknown</code>.</p>
<p>The SYS part describes the OS that is used. Typical values include <code>win32</code>, <code>linux</code>, and <code>darwin</code>
for desktop platforms. <code>none</code> is used for bare-metal usage.</p>
<p>The ABI part describes how the process starts up. <code>eabi</code> is used for bare metal, while <code>gnu</code> is used
for glibc, <code>musl</code> for musl, etc.</p>
<p>Now that you have a target triple, create a file with the name of the triple and a <code>.json</code>
extension. For example, a file describing <code>armv7a-none-eabi</code> would have the filename
<code>armv7a-none-eabi.json</code>.</p>
<h2 id="fill-the-target-file"><a class="header" href="#fill-the-target-file">Fill the target file</a></h2>
<p>The target file must be valid JSON. There are two places where its contents are described:
<a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_target/spec/struct.Target.html"><code>Target</code></a>, where every field is mandatory, and <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_target/spec/struct.TargetOptions.html"><code>TargetOptions</code></a>, where every field is optional.
<strong>All underscores are replaced with hyphens</strong>.</p>
<p>The recommended way is to base your target file on the specification of a built-in target that's
similar to your target system, then tweak it to match the properties of your target system. To do
so, use the command
<code>rustc +nightly -Z unstable-options --print target-spec-json --target $SOME_SIMILAR_TARGET</code>, using
<a href="./compiler-support.html#built-in-target">a target that's already built into the compiler</a>.</p>
<p>You can pretty much copy that output into your file. Start with a few modifications:</p>
<ul>
<li>Remove <code>"is-builtin": true</code></li>
<li>Fill <code>llvm-target</code> with <a href="https://clang.llvm.org/docs/CrossCompilation.html#target-triple">the triple that LLVM expects</a></li>
<li>Decide on a panicking strategy. A bare metal implementation will likely use
<code>"panic-strategy": "abort"</code>. If you decide not to <code>abort</code> on panicking, unless you <a href="./smallest-no-std.html#eh_personality">tell Cargo
to</a> per-project, you must define an <a href="./smallest-no-std.html#eh_personality">eh_personality</a> function.</li>
<li>Configure atomics. Pick the first option that describes your target:
<ul>
<li>I have a single-core processor, no threads, <a href="https://github.com/rust-lang/rust/issues/58500#issuecomment-654341233"><strong>no interrupts</strong></a>, or any way for
multiple things to be happening in parallel: if you are <strong>sure</strong> that is the case, such as WASM
(for now), you may set <code>"singlethread": true</code>. This will configure LLVM to convert all atomic
operations to use their single threaded counterparts. Incorrectly using this option may result
in UB if using threads or interrupts.</li>
<li>I have native atomic operations: set <code>max-atomic-width</code> to the biggest type in bits that your
target can operate on atomically. For example, many ARM cores have 32-bit atomic operations. You
may set <code>"max-atomic-width": 32</code> in that case.</li>
<li>I have no native atomic operations, but I can emulate them myself: set <code>max-atomic-width</code> to the
highest number of bits that you can emulate up to 128, then implement all of the
<a href="http://llvm.org/docs/Atomics.html#libcalls-atomic">atomic</a> and <a href="http://llvm.org/docs/Atomics.html#libcalls-sync">sync</a> functions expected by LLVM as
<code>#[no_mangle] unsafe extern "C"</code>. These functions have been standardized by GCC, so the <a href="https://gcc.gnu.org/onlinedocs/gcc/_005f_005fsync-Builtins.html">GCC
documentation</a> may have more notes. Missing functions will cause a linker error, while
incorrectly implemented functions will possibly cause UB. For example, if you have a
single-core, single-thread processor with interrupts, you can implement these functions to
disable interrupts, perform the regular operation, and then re-enable them.</li>
<li>I have no native atomic operations: you'll have to do some unsafe work to manually ensure
synchronization in your code. You must set <code>"max-atomic-width": 0</code>.</li>
</ul>
</li>
<li>Change the linker if integrating with an existing toolchain. For example, if you're using a
toolchain that uses a custom build of GCC, set <code>"linker-flavor": "gcc"</code> and <code>linker</code> to the
command name of your linker. If you require additional linker arguments, use <code>pre-link-args</code> and
<code>post-link-args</code> as so:
<pre><code class="language-json">"pre-link-args": {
    "gcc": [
        "-Wl,--as-needed",
        "-Wl,-z,noexecstack",
        "-m64"
    ]
},
"post-link-args": {
    "gcc": [
        "-Wl,--allow-multiple-definition",
        "-Wl,--start-group,-lc,-lm,-lgcc,-lstdc++,-lsupc++,--end-group"
    ]
}
</code></pre>
Ensure that the linker type is the key within <code>link-args</code>.</li>
<li>Configure LLVM features. Run <code>llc -march=ARCH -mattr=help</code> where ARCH is the base architecture
(not including the version in the case of ARM) to list the available features and their
descriptions. <strong>If your target requires strict memory alignment access (e.g. <code>armv5te</code>), make sure
that you enable <code>strict-align</code></strong>. To enable a feature, place a plus before it. Likewise, to
disable a feature, place a minus before it. Features should be comma-separated like so:
<code>"features": "+soft-float,+neon"</code>. Note that this may not be necessary if LLVM knows enough about
your target based on the provided triple and CPU.</li>
<li>Configure the CPU that LLVM uses if you know it. This will enable CPU-specific optimizations and
features. At the top of the output of the command in the last step, there is a list of known CPUs.
If you know that you will be targeting a specific CPU, you may set it in the <code>cpu</code> field in the
JSON target file.</li>
</ul>
<h2 id="use-the-target-file"><a class="header" href="#use-the-target-file">Use the target file</a></h2>
<p>Once you have a target specification file, you may refer to it by its path or by its name (i.e.
excluding <code>.json</code>) if it is in the current directory or in <code>$RUST_TARGET_PATH</code>.</p>
<p>Verify that it is readable by <code>rustc</code>:</p>
<pre><code class="language-sh">❱ rustc --print cfg --target foo.json # or just foo if in the current directory
debug_assertions
target_arch="arm"
target_endian="little"
target_env=""
target_feature="mclass"
target_feature="v7"
target_has_atomic="16"
target_has_atomic="32"
target_has_atomic="8"
target_has_atomic="cas"
target_has_atomic="ptr"
target_os="none"
target_pointer_width="32"
target_vendor=""
</code></pre>
<p>Now, you finally get to use it! Many resources have been recommending <a href="https://github.com/japaric/xargo"><code>xargo</code></a> or <a href="https://github.com/rust-osdev/cargo-xbuild"><code>cargo-xbuild</code></a>.
However, its successor, cargo's <code>build-std</code> feature, has received a lot of work recently and has
quickly reached feature parity with the other options. As such, this guide will only cover that
option.</p>
<p>Start with a bare minimum <a href="./smallest-no-std.html"><code>no_std</code> program</a>. Now, run
<code>cargo build -Z build-std=core --target foo.json</code>, again using the above rules about referencing the
path. Hopefully, you should now have a binary in the target directory.</p>
<p>You may optionally configure cargo to always use your target. See the recommendations at the end of
the page about <a href="./smallest-no-std.html">the smallest <code>no_std</code> program</a>. However, you'll currently have to
use the flag <code>-Z build-std=core</code> as that option is unstable.</p>
<h3 id="build-additional-built-in-crates"><a class="header" href="#build-additional-built-in-crates">Build additional built-in crates</a></h3>
<p>When using cargo's <code>build-std</code> feature, you can choose which crates to compile in. By default, when
only passing <code>-Z build-std</code>, <code>std</code>, <code>core</code>, and <code>alloc</code> are compiled. However, you may want to
exclude <code>std</code> when compiling for bare-metal. To do so, specify the crated you'd like after
<code>build-std</code>. For example, to include <code>core</code> and <code>alloc</code>, pass <code>-Z build-std=core,alloc</code>.</p>
<h2 id="troubleshooting"><a class="header" href="#troubleshooting">Troubleshooting</a></h2>
<h3 id="language-item-required-but-not-found-eh_personality"><a class="header" href="#language-item-required-but-not-found-eh_personality">language item required, but not found: <code>eh_personality</code></a></h3>
<p>Either add <code>"panic-strategy": "abort"</code> to your target file, or define an <a href="./smallest-no-std.html#eh_personality">eh_personality</a> function.
Alternatively, <a href="./smallest-no-std.html#eh_personality">tell Cargo to ignore it</a>.</p>
<h3 id="undefined-reference-to-__sync_val_compare_and_swap_"><a class="header" href="#undefined-reference-to-__sync_val_compare_and_swap_">undefined reference to <code>__sync_val_compare_and_swap_#</code></a></h3>
<p>Rust thinks that your target has atomic instructions, but LLVM doesn't. Go back to the step about
<a href="#fill-the-target-file">configuring atomics</a>. You will need to reduce the number in <code>max-atomic-width</code>.
See <a href="https://github.com/rust-lang/rust/issues/58500">#58500</a> for more details.</p>
<h3 id="could-not-find-sync-in-alloc"><a class="header" href="#could-not-find-sync-in-alloc">could not find <code>sync</code> in <code>alloc</code></a></h3>
<p>Similar to the above case, Rust doesn't think that you have atomics. You must implement them
yourself or <a href="#fill-the-target-file">tell Rust that you have atomic instructions</a>.</p>
<h3 id="multiple-definition-of-__something"><a class="header" href="#multiple-definition-of-__something">multiple definition of <code>__(something)</code></a></h3>
<p>You're likely linking your Rust program with code built from another language, and the other
language includes compiler built-ins that Rust also creates. To fix this, you'll need to tell your
linker to allow multiple definitions. If using gcc, you may add:</p>
<pre><code class="language-json">"post-link-args": {
    "gcc": [
        "-Wl,--allow-multiple-definition"
    ]
}
</code></pre>
<h3 id="error-adding-symbols-file-format-not-recognized"><a class="header" href="#error-adding-symbols-file-format-not-recognized">error adding symbols: file format not recognized</a></h3>
<p>Switch to cargo's <code>build-std</code> feature and update your compiler. This <a href="https://github.com/rust-lang/cargo/issues/8239">was a bug</a> introduced
for a few compiler builds that tried to pass in internal Rust object to an external linker.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="compiler-support.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="soc-support.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="compiler-support.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="soc-support.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
